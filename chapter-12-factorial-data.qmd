```{r echo = FALSE, warning = FALSE, message=FALSE}
source("init.R")
source("images/part_1/part_1_data.R")
```

# Fleas of animals {#sec-data-examples}

*Last modified on `r format(fs::file_info("chapter-12-factorial-data.qmd")$modification_time, '%d. %B %Y at %H:%M:%S')`*

> *"A quote." --- Dan Meyer*

## General background

What is a data grid?

## Theoretical background


```{r}
#| message: false
#| echo: false
#| warning: false
#| fig-align: center
#| fig-height: 5.5
#| fig-width: 7
#| fig-cap: "foo"
#| label: fig-stat-fire

geom_fire_alarm <- function(x, y, alarm = FALSE, fire = FALSE) {
  list(
    geom_curve(aes(x = x-0.25, y = y+0.25, xend = x-0.25, yend = y+1.5),
               curvature = -0.8, color = "black", linewidth = 0.5, lineend = "round"),
    annotate("point", x = x, y = y, shape = 24, fill = "#E16462FF", color = "black", size = 10),
    annotate("point", x = x, y = y+0.75, shape = 21, fill = "#E16462FF", color = "black", size = 10),
    annotate("point", x = x, y = y+0.75, shape = 16, color = "black", size = 2),
    annotate("point", x = x-0.25, y = y+1.5, shape = 16, color = "black", size = 3),  
    annotate("rect", xmin = x +1.5, xmax = x + 4.5, ymin = y, ymax = y - 2, fill = "gray80"),
    geom_shape(data = tibble(x = c(x+4.5, x+5, x+5, x+4.5), 
                             y = c(y+0, y+0.5, y-1.5, y-2)),
               aes(x, y), fill = "gray50"),
    geom_shape(data = tibble(x = c(x+1.5, x+2, x+5, x+4.5), 
                             y = c(y+0, y+0.5, y+0.5, y+0)),
               aes(x, y), fill = "gray65"),
    annotate("segment", x = x+2.25, xend = x +3.75, y = y-0.9, yend = y-0.9),
    annotate("segment", x = x+2.25, xend = x +3.75, y = y-1.1, yend = y-1.1),
    annotate("point", x = c(x+2.25, x +3.75), y = y-0.25, shape = 10, size = 2),
    geom_ellipse(aes(x0 = x + 2.5, y0 = y+0.25, a = 0.5, b = 0.15, angle = 0), fill = "gray20"),
    geom_ellipse(aes(x0 = x + 4, y0 = y+0.25, a = 0.5, b = 0.15, angle = 0), fill = "gray20"),
    if(alarm) {
      list(
        geom_curve(aes(x = x+0.5, y = y+0.35, xend = x+0.25, yend = y+1.35),
                   curvature = 0.7, color = "#0D0887FF", linewidth = 0.5, lineend = "round"), 
        geom_curve(aes(x = x+0.6, y = y+0.25, xend = x+0.35, yend = y+1.45),
                   curvature = 0.7, color = "#0D0887FF", linewidth = 0.5, lineend = "round"),
        geom_curve(aes(x = x+0.7, y = y+0.15, xend = x+0.45, yend = y+1.55),
                   curvature = 0.7, color = "#0D0887FF", linewidth = 0.5, lineend = "round"),
        geom_curve(aes(x = x+0.8, y = y+0.05, xend = x+0.55, yend = y+1.65),
                   curvature = 0.7, color = "#0D0887FF", linewidth = 0.5, lineend = "round"),
        annotate("label", x = x, y = y-0.2, shape = 16, color = "black", size = 1.6, 
                 label = "ALARM", fontface = 2)
      )
    },
    if(fire){
      list(
        geom_image(aes(x = x+4, y = y+1.05, image = "images/fire.png"), size = 0.06),
        geom_shape(data = tibble(x = c(x+2, x+4, x+4, x+2), 
                                 y = c(y-0.5, y-0.5, y-1.5, y-1.5)),
                   aes(x, y), fill = "#FCA63680", radius = unit(0.1, 'cm'))
      )
    } else {
      geom_shape(data = tibble(x = c(x+2, x+4, x+4, x+2), 
                               y = c(y-0.5, y-0.5, y-1.5, y-1.5)),
                 aes(x, y), fill = "#0D088780", radius = unit(0.1, 'cm'))
    }
  )
}

ggplot() +
  theme_void() +
  coord_cartesian(xlim = c(-9.1, 9.2), ylim = c(-9.2, 9.1)) +
  scale_x_continuous(breaks = seq(-10,10,1)) +
  scale_y_continuous(breaks = seq(-10,10,1)) +
#  geom_hline(yintercept = c(-10, -2, 6), color = "gray75") +
#  geom_vline(xintercept = c(-6, 2, 10), color = "gray75") +
  geom_fire_alarm(x = 4, y = 4, alarm = "TRUE") +
  geom_fire_alarm(x = -4, y = 4, alarm = "TRUE", fire = "TRUE") +
  geom_fire_alarm(x = 4, y = -4) +
  geom_fire_alarm(x = -4, y = -4, fire = "TRUE") +
  ## coords
  annotate("segment", x = -10, y = -10, xend = 10, yend = -10, size = 1) +
  annotate("segment", x = -8, y = -2, xend = 10, yend = -2, size = 1) +
  annotate("segment", x = -10, y = 6, xend = 10, yend = 6, size = 1) +
  annotate("segment", x = -6, y = 10, xend = -6, yend = -10, size = 1) +
  annotate("segment", x = 2, y = 8, xend = 2, yend = -10, size = 1) +
  annotate("segment", x = 10, y = 10, xend = 10, yend = -10, size = 1) +
  ## text
  annotate("text", x = -2, y = 1.5, label = "ALARM with FIRE", fontface = 3) +
  annotate("text", x = -2, y = 0.5, label = "Power / True positive", fontface = 2, size = 5) +
  annotate("text", x = -2, y = -0.5, label = expression(1-beta~"="~80*"%"), size = 4.5) + 
  annotate("text", x = -2, y = -1.5, label = "We believe in this to be high.", fontface = 3.5,
           size = 4) +
  annotate("text", x = 6, y = 1.5, label = "ALARM without FIRE", fontface = 3) +
  annotate("text", x = 6, y = 0.5, label = "Type I error / False positive", fontface = 2, size = 5) +
  annotate("text", x = 6, y = -0.5, label = expression(alpha~"="~5*"%"), size = 4.5) +
  annotate("text", x = 6, y = -1.5, label = "We control this in our testing.", fontface = 3.5,
           size = 4) +
  annotate("text", x = -2, y = -6.5, label = "FIRE without ALARM", fontface = 3) +
  annotate("text", x = -2, y = -7.5, label = "Type II error / False negative", 
           fontface = 2, size = 5) +
  annotate("text", x = -2, y = -8.5, label = expression(beta~"="~20*"%"), size = 4.5) +
  annotate("text", x = -2, y = -9.5, label = "We cannot control this in our testing.", 
           fontface = 3, size = 4) +
  annotate("text", x = 6, y = -6.5, label = "No FIRE, no ALARM", fontface = 3) +
  annotate("text", x = 6, y = -7.5, label = "True negative", fontface = 2, size = 5) +
  annotate("text", x = 6, y = -8.5, label = expression(1-alpha~"="~95*"%"), size = 4.5) +
  annotate("text", x = 6, y = -9.5, label = "We are rarely interested in.", 
           fontface = 3, size = 4) +
  ## columns
  annotate("text", x = 2, y = 9, label = "Unkown truth in the population", fontface = 2, size = 7.5) +
  annotate("text", x = -2, y = 7, label = "Null is false / effect", fontface = 2, size = 5.5) +
  annotate("text", x = 6, y = 7, label = "Null is true / no effect", fontface = 2, size = 5.5) +
  ## rows
  annotate("text", x = -9, y = -2, label = "Decision by a statistical test", fontface = 2, 
           size = 7.5, angle = 90) +
  annotate("text", x = -7, y = 2, label = "Reject Null / effect", fontface = 2, size = 5.5, angle = 90) +
  annotate("text", x = -7, y = -6, label = "Keep Null / no effect", fontface = 2, size = 5.5, angle = 90) 
  
```



```{r}
#| message: false
#| echo: false
#| warning: false
#| fig-align: center
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "foo"
#| label: fig-factorial-data-overview 
p_factorial_data_overview 
```


```{r}
#| message: false
#| echo: false
#| warning: false
#| fig-align: center
#| fig-height: 4
#| fig-width: 7
#| fig-cap: "foo"
#| label: fig-covariate-data-overview 
p_covariate_data_overview 
```



## R packages used

```{r}
#| message: false
#| warning: false
pacman::p_load(tidyverse, conflicted)
```


@wickham2023r

## Data

Small data and grid

### Jump performances of fleas

@cadiergues2000comparison


```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-chap-01-flea
#| fig-align: center
#| fig-height: 2
#| fig-width: 7
#| fig-cap: "foo **(A)** foo **(B)** foo"
flea_jump_exp_p
```

*C. felis felis* jump was $19.9 \pm 9.1cm$ with a range from $2$ to $48cm$ 

*C. canis* jump was longer $30.4 \pm 9.1cm$  with a range from $3$ to $50cm$


```{r}
jump_flea_grid <- expand_grid(host = c("cat", "dog")) |> 
  mutate(mean = c(19.9, 30.4), 
         sd = c(9.1))
```

```{r}
jump_flea_tbl <- jump_flea_grid |> 
  rowwise() |> 
  mutate(jumplength = lst(rnorm(7, mean, sd))) |> 
  unnest(cols = jumplength) |> 
  mutate(host = as_factor(host))
```


```{r}
jump_flea_tbl |> 
  group_by(host) |> 
  summarise(mean(jumplength),
            sd(jumplength)) |> 
  mutate_if(is.numeric, round, 2)
```


```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-chap-11-fac-01
#| fig-align: center
#| fig-height: 3.5
#| fig-width: 7
#| fig-cap: "foo **(A)** foo **(B)** foo"

jump_flea_tbl |> 
  ggplot(aes(x = host, y = jumplength, fill = host)) +
  theme_book() +
  geom_point(position = position_nudge(-0.075),
             show.legend = FALSE, shape = 21) +
  stat_summary(fun.data=mean_sdl, fun.args = list(mult = 1), 
               geom="pointrange", shape = 23, size = 1,
               show.legend = FALSE) +
  stat_summary(fun = mean, geom = "label", aes(label = round(..y..,2)),
               size = 4, position = position_nudge(x = 0.05), alpha = 0.5,
               show.legend = FALSE, hjust = "left") +
  labs(x = "Flea host", y = "Jump length in [cm]",
       fill = "Host") +
  scale_fill_viridis(discrete = TRUE, option = "plasma") +
  coord_cartesian(ylim = c(0, NA))
```



```{r}
jump_animals_grid <- expand_grid(host = c("cat", "fox", "rat", "dog")) |> 
  mutate(mean = c(19.9, 35.2, 15.2, 30.4), 
         sd = c(9.1, 10.3, 4.6, 9.1))
```

```{r}
jump_animals_tbl <- jump_animals_grid |> 
  rowwise() |> 
  mutate(jumplength = lst(rnorm(7, mean, sd))) |> 
  unnest(cols = jumplength) |> 
  mutate(host = as_factor(host))
```


```{r}
jump_animals_tbl |> 
  group_by(host) |> 
  summarise(mean(jumplength),
            sd(jumplength)) |> 
  mutate_if(is.numeric, round, 2)
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-chap-11-fac-02
#| fig-align: center
#| fig-height: 3.5
#| fig-width: 7
#| fig-cap: "foo **(A)** foo **(B)** foo"

jump_animals_tbl |> 
  ggplot(aes(x = host, y = jumplength, fill = host)) +
  theme_book() +
  geom_point(position = position_nudge(-0.075),
             show.legend = FALSE, shape = 21) +
  stat_summary(fun.data=mean_sdl, fun.args = list(mult = 1), 
               geom="pointrange", shape = 23, size = 1,
               show.legend = FALSE) +
  stat_summary(fun = mean, geom = "label", aes(label = round(..y..,2)),
               size = 4, position = position_nudge(x = 0.075), alpha = 0.5,
               show.legend = FALSE, hjust = "left") +
  labs(x = "Flea host", y = "Jump length in [cm]",
       fill = "Host") +
  scale_fill_viridis(discrete = TRUE, option = "plasma") +
  coord_cartesian(ylim = c(0, NA))
```


### Measurements on animal fleas

- Jump length in [cm] called `jump_length`
- Number of hairs on each leg called `count_leg_left` and `count_leg_right`
- Ratings of each flea, as listed in the catalog of the Fédération Internationale de la Beauté des Puces (FIBP) called `rating` on a Likert scale from 1 to 5, with 5 being the strongest expression.
- The infection status with the flea cold is called `infected`, with a value of 0/1 for no/yes.

```{r}
tibble(jumplength = rnorm(7, 5, 1),
       countleg_left = rpois(7, 4),
       countleg_right = rpois(7, 4),
       countleg = (countleg_left + countleg_right)/2,
       rating = sample(1:5, 7, replace = TRUE, prob = c(0.1, 0.2, 0.4, 0.2, 0.1)),
       infectd = rbinom(7, prob = 0.5, size = 1))
```


### Fleas in urban and rural habitats

Why so complex?

@rpkg_purrr

```{r}
jump_habitat_grid <- expand_grid(host = 1:3, site = 1:2) |> 
  mutate(mean_host = c(19.9, 19.9, 30.4, 30.4, 15.2, 15.2),
         mean_site = c(5, 0, 5, 0, 5, -5),
         mean = mean_host + mean_site,
         sd = c(9.1, 9.1, 9.1, 9.1, 4.6, 4.6))
jump_habitat_grid
```

```{r}
jump_habitat_raw_tbl <- jump_habitat_grid |> 
  rowwise() |> 
  mutate(jumplength = lst(rnorm(7, mean, sd))) |> 
  unnest(cols = jumplength)
```



```{r}
jump_habitat_tbl <- jump_habitat_raw_tbl |> 
  select(host, site, jumplength) |> 
  mutate(host = factor(host, labels = c("cat", "dog", "rat")),
         site = factor(site, labels = c("urban", "rural"))) |> 
  mutate_if(is.numeric, round, 2)
```


```{r}
#| warning: false
#| message: false
jump_habitat_tbl |> 
  group_by(host, site) |> 
  summarise(mean(jumplength),
            sd(jumplength)) |> 
  mutate_if(is.numeric, round, 2)
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-chap-11-fac-03
#| fig-align: center
#| fig-height: 3.5
#| fig-width: 7
#| fig-cap: "foo **(A)** foo **(B)** foo"

jump_habitat_tbl |> 
  ggplot(aes(x = host, y = jumplength, fill = site)) +
  theme_book() +
  geom_point(position = position_dodge(0.5),
             show.legend = FALSE, shape = 21) +
  stat_summary(fun.data=mean_sdl, fun.args = list(mult = 1), 
               geom="pointrange", shape = 23, size = 1,
               show.legend = TRUE, position = position_dodge(0.9)) +
  stat_summary(fun = mean, geom = "label", aes(label = round(..y..,2)),
               size = 4, position = position_dodge(1.8), 
               alpha = 0.5, show.legend = FALSE) +
  labs(x = "Flea host", y = "Jump length in [cm]",
       fill = "Host") +
  scale_fill_viridis(discrete = TRUE, option = "plasma") +
  coord_cartesian(ylim = c(0, NA))
```

## Data availability

The data is available as txt-Files under <https://github.com/jkruppa/biodatascience>.

```{r}
#| echo: false

jump_animals_tbl |> 
  arrange(host) |> 
  mutate_if(is.numeric, round, 2) |> 
  write_delim("data/jump_animals.txt")

jump_flea_tbl |> 
  arrange(host) |> 
  mutate_if(is.numeric, round, 2) |> 
  write_delim("data/jump_fleas.txt")

jump_habitat_tbl |> 
  arrange(host, site) |> 
  mutate_if(is.numeric, round, 2) |> 
  write_delim("data/jump_habitat.txt")
```



## Alternatives 

Further tutorials and R packages on XXX

### Why linear is a bad idea?

```{r}
jump_flea_tbl <- tibble(host = rep(0:1, each = 7),
                        jump_length = 19.9 + 10.5 * host + rnorm(14, 0, 9.1)) |> 
  mutate(host = factor(host, labels = c("cat", "dog")))
```

### Why is a `tibble()` bad idea?

```{r}
jump_animals_tbl <- tibble(cat = rnorm(n = 7, mean = 19.9, sd = 9.1),
                           fox = rnorm(n = 7, mean = 35.2, sd = 10.3),
                           rat = rnorm(n = 7, mean = 15.2, sd = 4.6),
                           dog = rnorm(n = 7, mean = 30.4, sd = 9.1)) |>
  pivot_longer(cols = cat:dog, values_to = "jump_length", names_to = "host") |> 
  mutate(host = as_factor(host))
```


## Glossary

term

: what does it mean.

## The meaning of "Models of Reality" in this chapter.

- itemize with max. 5-6 words

## Summary

## References {.unnumbered}